networks:
  jarvis_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    external: false
    attachable: true
    driver_opts:
      com.docker.network.bridge.name: jarvis-br0
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: 1500

services:
  # Jarvis Secrets Daemon - Secure secrets management
  jarvis-secretsd:
    build:
      context: ./jarvis-secretsd
      dockerfile: Dockerfile.runtime
    container_name: jarvis_secretsd
    env_file:
      - ./jarvis-secretsd/.env
    networks:
      jarvis_network:
        ipv4_address: 172.20.0.5
    ports:
      - "127.0.0.1:8081:8081"
    cap_add:
      - IPC_LOCK
    ulimits:
      core: 0
      memlock: -1
    tmpfs:
      - /opt/jarvis/run:size=1M,mode=700,uid=1000
      - /tmp:noexec,nosuid,uid=1000
    volumes:
      - ./jarvis-secretsd/config.toml:/etc/jarvis-secretsd/config.toml:ro
      - ./jarvis-secretsd/policy.yaml:/etc/jarvis-secretsd/policy.yaml:ro
      - ./certs/pki:/etc/jarvis/certs/pki:ro
      - /etc/machine-id:/etc/machine-id:ro
      - secrets_data:/opt/jarvis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64M
    healthcheck:
      test: [ "CMD-SHELL", "bash -c '</dev/tcp/localhost/8081'" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    security_opt:
      - no-new-privileges:true

  # Container 3: Ollama Container - GPU Accelerated
  ollama:
    image: ollama/ollama:latest
    container_name: jarvis_ollama
    networks:
      jarvis_network:
        ipv4_address: 172.20.0.30
    ports:
      - "127.0.0.1:11435:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    environment:
      - OLLAMA_ORIGINS=*
      - OLLAMA_HOST=0.0.0.0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: [ "CMD", "bash", "-lc", "ollama --version >/dev/null 2>&1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # Container 4: Rust Core Backend (Main Backend Logic)
  backend:
    build:
      context: .
      dockerfile: core/Dockerfile
    container_name: jarvis_backend
    networks:
      jarvis_network:
        ipv4_address: 172.20.0.40
    ports:
      - "8100:8100"
    environment:
      - SECRETSD_URL=https://jarvis_secretsd:8081
      - CLIENT_ID=backend
      - OLLAMA_URL=http://jarvis_ollama:11434
      - QDRANT_URL=http://jarvis_qdrant:6333
      - TLS_CERT_PATH=/etc/jarvis/certs/server.crt
      - TLS_KEY_PATH=/etc/jarvis/certs/server.key
      - PORT=8100
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./data:/app/data
      - ./certs:/etc/jarvis/certs:ro
      - ./certs/pki:/etc/jarvis/certs/pki:ro
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      jarvis-secretsd:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ollama:
        condition: service_healthy
      qdrant:
        condition: service_started
      timescale:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8100/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  # Container 5: PostgreSQL with dynamic secret fetching
  postgres:
    build:
      context: .
      dockerfile: services/postgres.Dockerfile
    container_name: jarvis_postgres
    networks:
      jarvis_network:
        ipv4_address: 172.20.0.100
    environment:
      - POSTGRES_DB=jarvis_db
      - POSTGRES_USER=jarvis
      - SECRETSD_URL=http://jarvis-secretsd:8081
      - CLIENT_ID=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./certs/pki:/etc/jarvis/certs/pki:ro
    restart: unless-stopped
    depends_on:
      jarvis-secretsd:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jarvis -d jarvis_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Container 6: Redis
  redis:
    image: redis:7-alpine
    container_name: jarvis_redis
    networks:
      jarvis_network:
        ipv4_address: 172.20.0.110
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Container 7: Qdrant Vector DB
  qdrant:
    image: qdrant/qdrant:latest
    container_name: jarvis_qdrant
    networks:
      jarvis_network:
        ipv4_address: 172.20.0.120
    ports:
      - "127.0.0.1:6333:6333"
      - "127.0.0.1:6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped

  # Container 8: TimescaleDB with dynamic secret fetching
  timescale:
    build:
      context: .
      dockerfile: services/timescale.Dockerfile
    container_name: jarvis_timescale
    networks:
      jarvis_network:
        ipv4_address: 172.20.0.130
    environment:
      - POSTGRES_USER=jarvis
      - POSTGRES_DB=jarvis_timeseries
      - SECRETSD_URL=http://jarvis-secretsd:8081
      - CLIENT_ID=timescale
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./certs/pki:/etc/jarvis/certs/pki:ro
    restart: unless-stopped
    depends_on:
      jarvis-secretsd:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jarvis -d jarvis_timeseries"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Container 9: Open-WebUI
  open-webui:
    build:
      context: ./services/open-webui
      dockerfile: Dockerfile
    container_name: jarvis_open_webui
    networks:
      jarvis_network:
        ipv4_address: 172.20.0.60
    ports:
      - "3000:8080"
    environment:
      # --- SECURITY & CENTRALIZATION ---
      # Open-WebUI must talk ONLY to Jarvis Core.
      # No direct access to Ollama, Qdrant, or Secretsd allowed here.
      
      - SECRETSD_URL=http://jarvis-secretsd:8081
      - CLIENT_ID=open-webui
      
      # --- CORE CONNECTION ---
      # We use the 'openai' protocol to talk to Jarvis Core
      - OPENAI_API_BASE_URLS=http://jarvis_backend:8100/v1
      - OPENAI_API_KEYS=${JARVIS_INTERNAL_KEY}
      
      # --- AUDIO (Through Core) ---
      - AUDIO_STT_ENGINE=openai
      - AUDIO_STT_OPENAI_API_BASE_URL=http://jarvis_backend:8100/v1
      - AUDIO_STT_OPENAI_API_KEY=${JARVIS_INTERNAL_KEY}
      - AUDIO_STT_MODEL=whisper-1
      
      - AUDIO_TTS_ENGINE=openai
      - AUDIO_TTS_OPENAI_API_BASE_URL=http://jarvis_backend:8100/v1
      - AUDIO_TTS_OPENAI_API_KEY=${JARVIS_INTERNAL_KEY}
      - AUDIO_TTS_MODEL=tts-1
      - AUDIO_TTS_VOICE=alloy

      # --- RAG (DISABLED LOCALLY) ---
      # RAG is handled by Jarvis Core, not the UI.
      - ENABLE_RAG_WEB_SEARCH=False
      - ENABLE_RAG_LOCAL=False
      - RAG_EMBEDDING_ENGINE=openai 
      - RAG_OPENAI_API_BASE_URL=http://jarvis_backend:8100/v1
      - RAG_OPENAI_API_KEY=${JARVIS_INTERNAL_KEY}
      
    volumes:
      - open_webui_data:/app/backend/data
    restart: unless-stopped
    depends_on:
      jarvis-secretsd:
        condition: service_healthy
      backend:
        condition: service_healthy

volumes:
  open_webui_data:
  ollama_data:
  postgres_data:
  redis_data:
  qdrant_data:
  timescale_data:
  secrets_data: