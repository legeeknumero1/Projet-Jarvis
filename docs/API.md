# üîå Documentation API - Jarvis V1.3.1 üîê

## üì° Endpoints API - S√âCURIS√âS & PRODUCTION-READY

### Base URL
```
http://localhost:8000
```

### üîê Authentification JWT (Nouveau)
**Syst√®me d'authentification complet impl√©ment√© en v1.3.1**
- JWT tokens avec refresh automatique
- Authentification optionnelle (compatible mode d√©veloppement)
- Rate limiting : 10 requ√™tes/minute par IP
- CORS s√©curis√© avec origins restrictives

---

## üîÑ Endpoints principaux ACTIFS

### GET /
**Description** : Message de bienvenue de l'API Jarvis s√©curis√©e
**URL** : `http://localhost:8000/`
**M√©thode** : GET
**S√©curit√©** : Rate limiting actif
**R√©ponse** :
```json
{
  "message": "Jarvis AI Assistant is running",
  "version": "1.3.1",
  "status": "production-ready",
  "security": {
    "authentication": "JWT",
    "rate_limiting": "active",
    "cors": "secure"
  }
}
```

### GET /health
**Description** : V√©rification compl√®te du statut du syst√®me s√©curis√©
**URL** : `http://localhost:8000/health`
**M√©thode** : GET
**S√©curit√©** : Endpoints publics (pas d'auth requise)
**R√©ponse** :
```json
{
  "status": "healthy",
  "timestamp": "2025-01-22T23:45:00Z",
  "version": "1.3.1",
  "security_score": "9.2/10",
  "services": {
    "database": "connected_secure",
    "redis": "connected_auth", 
    "ollama": "running_secure",
    "memory": "initialized",
    "speech": "ready",
    "auth_system": "operational",
    "rate_limiting": "active"
  },
  "uptime": "2h 15m 30s",
  "environment": "production"
}
```

### POST /chat
**Description** : Envoi de message s√©curis√© √† Jarvis avec IA Ollama
**URL** : `http://localhost:8000/chat`
**M√©thode** : POST
**Headers** : 
```
Content-Type: application/json
Authorization: Bearer JWT_TOKEN  // Optionnel en mode dev
```
**S√©curit√©** : Rate limiting (10 req/min), Input validation stricte, Anti-XSS
**Body** :
```json
{
  "message": "string",                    // Message utilisateur (max 10000 chars, valid√©)
  "user_id": "string",                   // Optionnel, pattern: ^[a-zA-Z0-9_-]+$  
  "context": "string",                   // Optionnel, contexte conversation
  "save_memory": "boolean"               // Optionnel, sauvegarder en m√©moire
}
```
**R√©ponse** :
```json
{
  "response": "string",                  // R√©ponse de l'IA (logs sanitis√©s)
  "timestamp": "2025-01-22T23:45:00Z",
  "user_id": "string",
  "model": "llama3.2:1b",
  "memory_saved": "boolean",
  "conversation_id": "uuid",
  "security_validated": true,
  "rate_limit_remaining": 9
}
```

### WebSocket /ws
**Description** : Communication temps r√©el s√©curis√©e bidirectionnelle
**URL** : `ws://localhost:8001/ws`
**Protocole** : WebSocket avec s√©curit√© renforc√©e
**S√©curit√©** : Thread-safe avec RLock, Timeout 30s, Cleanup automatique, Heartbeat
**Messages envoy√©s** :
```json
{
  "type": "message",
  "message": "string",
  "user_id": "string",
  "timestamp": "2025-01-22T23:45:00Z",
  "auth_token": "string"  // Optionnel
}
```
**Messages re√ßus** :
```json
{
  "type": "response",
  "response": "string",
  "timestamp": "2025-01-22T23:45:00Z",
  "user_id": "string",
  "conversation_id": "uuid",
  "connection_secure": true,
  "cleanup_status": "ok"
}
```

---

## üîê **ENDPOINTS AUTHENTIFICATION (NOUVEAUX)**

### POST /auth/register
**Description** : Cr√©ation de compte utilisateur
**URL** : `http://localhost:8000/auth/register`
**M√©thode** : POST
**Headers** : `Content-Type: application/json`
**Body** :
```json
{
  "email": "string",          // Email valide (validation stricte)
  "password": "string"        // Mot de passe s√©curis√© (min 8 chars)
}
```
**R√©ponse** :
```json
{
  "message": "User registered successfully",
  "user_id": "uuid",
  "timestamp": "2025-01-22T23:45:00Z"
}
```

### POST /auth/login  
**Description** : Connexion utilisateur avec JWT
**URL** : `http://localhost:8000/auth/login`
**M√©thode** : POST
**Body** :
```json
{
  "email": "string",
  "password": "string"
}
```
**R√©ponse** :
```json
{
  "access_token": "jwt_token",
  "refresh_token": "jwt_refresh_token",
  "token_type": "bearer",
  "expires_in": 1800,
  "user": {
    "id": "uuid",
    "email": "string",
    "role": "user"
  }
}
```

### POST /auth/refresh
**Description** : Rafra√Æchissement du token JWT
**URL** : `http://localhost:8000/auth/refresh`
**Headers** : `Authorization: Bearer REFRESH_TOKEN`
**R√©ponse** :
```json
{
  "access_token": "new_jwt_token",
  "token_type": "bearer",
  "expires_in": 1800
}
```

### POST /auth/logout
**Description** : D√©connexion s√©curis√©e
**URL** : `http://localhost:8000/auth/logout`
**Headers** : `Authorization: Bearer JWT_TOKEN`
**R√©ponse** :
```json
{
  "message": "Successfully logged out"
}
```

### GET /auth/me
**Description** : Profil utilisateur connect√©
**URL** : `http://localhost:8000/auth/me`
**Headers** : `Authorization: Bearer JWT_TOKEN`
**R√©ponse** :
```json
{
  "id": "uuid",
  "email": "string",
  "role": "user|admin|superuser",
  "created_at": "2025-01-22T23:45:00Z",
  "last_login": "2025-01-22T23:45:00Z"
}
```

### GET /auth/health
**Description** : Status du syst√®me d'authentification
**URL** : `http://localhost:8000/auth/health`
**R√©ponse** :
```json
{
  "status": "operational",
  "jwt_system": "active",
  "rate_limiting": "10_req_per_min",
  "total_users": 5,
  "active_sessions": 2
}
```

---

## üìä **ENDPOINTS M√âTRIQUES (NOUVEAUX)**

### GET /metrics
**Description** : M√©triques Prometheus format pour monitoring
**URL** : `http://localhost:8000/metrics`
**M√©thode** : GET
**Format** : Prometheus (text/plain)
**R√©ponse** :
```
# TYPE jarvis_requests_total counter
jarvis_requests_total{endpoint="/chat"} 150
jarvis_requests_total{endpoint="/health"} 45

# TYPE jarvis_requests_errors_total counter  
jarvis_requests_errors_total{endpoint="/chat",error="rate_limit"} 5

# TYPE jarvis_response_time_seconds histogram
jarvis_response_time_seconds_sum{endpoint="/chat"} 25.5
jarvis_response_time_seconds_count{endpoint="/chat"} 150

# TYPE jarvis_active_connections gauge
jarvis_active_connections 8

# TYPE jarvis_service_status gauge
jarvis_service_status{service="database"} 1
jarvis_service_status{service="redis"} 1
jarvis_service_status{service="ollama"} 1
```

---

## üé§ Endpoints Vocaux S√âCURIS√âS

### POST /voice/transcribe
**Description** : Transcription audio s√©curis√©e vers texte avec Whisper
**URL** : `http://localhost:8000/voice/transcribe`
**M√©thode** : POST
**Headers** : 
```
Content-Type: multipart/form-data
Authorization: Bearer JWT_TOKEN  // Optionnel
```
**S√©curit√©** : Timeout s√©curis√©, Validation format, Rate limiting
**Body** : FormData avec fichier audio
```
audio: File (formats: wav, mp3, m4a, ogg - Taille max: 25MB)
language: string (optionnel, d√©faut: "fr")
user_id: string (optionnel, valid√©)
```
**R√©ponse** :
```json
{
  "transcript": "string",               // Texte transcrit (sanitis√©)
  "confidence": 0.95,                  // Score de confiance
  "language": "fr",                    // Langue d√©tect√©e
  "duration": 3.2,                     // Dur√©e audio en secondes
  "timestamp": "2025-01-22T23:45:00Z",
  "user_id": "string",
  "security_validated": true,
  "processing_time": 1.8               // Temps traitement s√©curis√©
}
```

### POST /voice/synthesize
**Description** : Synth√®se vocale s√©curis√©e avec Piper TTS
**URL** : `http://localhost:8000/voice/synthesize`
**M√©thode** : POST
**Headers** : 
```
Content-Type: application/json
Authorization: Bearer JWT_TOKEN  // Optionnel
```
**S√©curit√©** : Validation input, Retry patterns, Timeout configurable, Logs sanitis√©s
**Body** :
```json
{
  "text": "string",                      // Texte √† synth√©tiser (max 5000 chars, valid√©)
  "voice": "string",                  // Optionnel, mod√®le voix valid√©
  "speed": 1.0,                      // Optionnel, vitesse 0.5-2.0
  "user_id": "string"                // Optionnel, pattern valid√©
}
```
**R√©ponse** : Fichier audio WAV s√©curis√©
**Headers de r√©ponse** :
```
Content-Type: audio/wav
Content-Disposition: attachment; filename="synthesis_secure.wav"
X-Processing-Time: 2.1
X-Security-Validated: true
```

---

## üß† Endpoints M√©moire OP√âRATIONNELS

### GET /memory/{user_id}
**Description** : R√©cup√©ration des m√©moires utilisateur
**URL** : `http://localhost:8000/memory/{user_id}`
**M√©thode** : GET
**Param√®tres** :
- `user_id` : Identifiant utilisateur
- `limit` : Nombre max de m√©moires (optionnel, d√©faut: 50)
- `category` : Cat√©gorie de m√©moire (optionnel)
**R√©ponse** :
```json
{
  "memories": [
    {
      "id": "uuid",
      "content": "string",
      "category": "conversation|fact|preference|reminder",
      "importance": 5,
      "created_at": "2025-07-19T19:45:00Z",
      "accessed_at": "2025-07-19T19:45:00Z",
      "access_count": 3
    }
  ],
  "total": 150,
  "user_id": "string"
}
```

### POST /memory/store
**Description** : Stockage d'une nouvelle m√©moire
**URL** : `http://localhost:8000/memory/store`
**M√©thode** : POST
**Body** :
```json
{
  "content": "string",                  // Contenu de la m√©moire
  "user_id": "string",               // Identifiant utilisateur
  "category": "conversation",         // conversation|fact|preference|reminder
  "importance": 5,                   // 1-10, niveau d'importance
  "metadata": {}                     // optionnel, m√©tadonn√©es additionnelles
}
```
**R√©ponse** :
```json
{
  "id": "uuid",
  "status": "stored",
  "embedding_created": true,
  "timestamp": "2025-07-19T19:45:00Z"
}
```

### POST /memory/search
**Description** : Recherche s√©mantique dans les m√©moires
**URL** : `http://localhost:8000/memory/search`
**M√©thode** : POST
**Body** :
```json
{
  "query": "string",                 // Requ√™te de recherche
  "user_id": "string",              // Identifiant utilisateur
  "limit": 10,                      // Nombre max de r√©sultats
  "threshold": 0.7,                 // Seuil de similarit√©
  "category": "string"              // optionnel, filtrer par cat√©gorie
}
```
**R√©ponse** :
```json
{
  "results": [
    {
      "memory": {
        "id": "uuid",
        "content": "string",
        "category": "string",
        "importance": 5,
        "created_at": "datetime"
      },
      "similarity": 0.89,           // Score de similarit√©
      "relevance": "high"           // high|medium|low
    }
  ],
  "query": "string",
  "total_found": 5
}
```

---

## ü§ñ Endpoints Ollama OP√âRATIONNELS

### POST /ollama/chat
**Description** : Communication directe avec Ollama avec m√©moire contextuelle
**URL** : `http://localhost:8000/ollama/chat`
**M√©thode** : POST
**Body** :
```json
{
  "message": "string",               // Message utilisateur
  "user_id": "string",              // Identifiant utilisateur
  "include_memory": true,           // Inclure m√©moire contextuelle
  "model": "llama3.2:1b",          // optionnel, mod√®le √† utiliser
  "system_prompt": "string",        // optionnel, prompt syst√®me
  "temperature": 0.7                // optionnel, cr√©ativit√© r√©ponse
}
```
**R√©ponse** :
```json
{
  "response": "string",             // R√©ponse de l'IA
  "model": "llama3.2:1b",          // Mod√®le utilis√©
  "timestamp": "2025-07-19T19:45:00Z",
  "memory_used": true,              // M√©moire utilis√©e
  "context_tokens": 156,            // Tokens de contexte
  "response_tokens": 89,            // Tokens de r√©ponse
  "generation_time": 1.2            // Temps g√©n√©ration (secondes)
}
```

### GET /ollama/models
**Description** : Liste des mod√®les Ollama disponibles
**URL** : `http://localhost:8000/ollama/models`
**M√©thode** : GET
**R√©ponse** :
```json
{
  "models": [
    {
      "name": "llama3.2:1b",
      "size": "1.3GB",
      "modified_at": "2025-07-19T15:30:00Z",
      "digest": "sha256:abc123...",
      "details": {
        "family": "llama",
        "parameter_size": "1B",
        "quantization_level": "Q4_0"
      }
    }
  ],
  "total": 1,
  "default_model": "llama3.2:1b"
}
```

### GET /ollama/status
**Description** : Statut d√©taill√© du service Ollama
**URL** : `http://localhost:8000/ollama/status`
**M√©thode** : GET
**R√©ponse** :
```json
{
  "status": "running",              // running|stopped|error
  "model_loaded": "llama3.2:1b",   // Mod√®le actuellement charg√©
  "memory_usage": "2.1GB",         // Utilisation m√©moire
  "gpu_usage": "45%",              // Utilisation GPU (si applicable)
  "uptime": "5h 23m",              // Temps de fonctionnement
  "version": "0.1.17",             // Version Ollama
  "available": true                // Service disponible
}
```

### GET /memory/{user_id}
**Description** : R√©cup√©ration des m√©moires utilisateur
**R√©ponse** :
```json
{
  "memories": [
    {
      "content": "string",
      "category": "string",
      "importance": "integer",
      "created_at": "datetime"
    }
  ]
}
```

### POST /memory/search
**Description** : Recherche dans les m√©moires
**Body** :
```json
{
  "query": "string",
  "user_id": "string",
  "limit": "integer"
}
```

### GET /homeassistant/entities
**Description** : Liste des entit√©s Home Assistant
**R√©ponse** :
```json
{
  "entities": [
    {
      "entity_id": "string",
      "state": "string",
      "attributes": "object"
    }
  ]
}
```

### POST /homeassistant/control
**Description** : Contr√¥le des appareils domotiques
**Body** :
```json
{
  "entity_id": "string",
  "action": "string",
  "value": "any" // optionnel
}
```

---

## üîÑ Codes d'erreur

### 400 - Bad Request
```json
{
  "detail": "Message d'erreur d√©taill√©"
}
```

### 500 - Internal Server Error
```json
{
  "detail": "Erreur interne du serveur"
}
```

### 503 - Service Unavailable
```json
{
  "detail": "Service temporairement indisponible"
}
```

---

## üîß Endpoints Ollama

### POST /ollama/chat
**Description** : Communication directe avec Ollama avec m√©moire
**Body** :
```json
{
  "message": "string",
  "user_id": "string",
  "include_memory": "boolean"
}
```
**R√©ponse** :
```json
{
  "response": "string",
  "model": "string",
  "timestamp": "2025-01-17T17:00:00Z",
  "memory_used": "boolean"
}
```

### GET /ollama/models
**Description** : Liste des mod√®les Ollama disponibles
**R√©ponse** :
```json
{
  "models": [
    {
      "name": "string",
      "size": "string",
      "modified_at": "datetime"
    }
  ]
}
```

### GET /ollama/status
**Description** : Statut du service Ollama
**R√©ponse** :
```json
{
  "status": "running|stopped|error",
  "model_loaded": "string",
  "memory_usage": "string"
}
```

---

## üß† Endpoints M√©moire

### POST /memory/store
**Description** : Stockage d'une nouvelle m√©moire
**Body** :
```json
{
  "content": "string",
  "user_id": "string",
  "category": "conversation|fact|preference|reminder",
  "importance": "integer"
}
```

### GET /memory/stats/{user_id}
**Description** : Statistiques de m√©moire utilisateur
**R√©ponse** :
```json
{
  "total_memories": "integer",
  "categories": "object",
  "oldest_memory": "datetime",
  "newest_memory": "datetime"
}
```

---

## üéõÔ∏è Endpoints Services

### GET /services/status
**Description** : Statut de tous les services
**R√©ponse** :
```json
{
  "database": "healthy|unhealthy",
  "redis": "healthy|unhealthy", 
  "ollama": "healthy|unhealthy",
  "hybrid_server": "running|stopped"
}
```

### POST /services/restart/{service_name}
**Description** : Red√©marrage d'un service sp√©cifique
**Param√®tres** : service_name (database|redis|ollama|hybrid_server)

---

---

## üåê **ENDPOINTS INTERNET MCP S√âCURIS√âS**

### POST /web/search
**Description** : Recherche web s√©curis√©e avec MCP Browserbase
**URL** : `http://localhost:8000/web/search`
**M√©thode** : POST
**Headers** :
```
Content-Type: application/json
Authorization: Bearer JWT_TOKEN  // Optionnel
```
**S√©curit√©** : Rate limiting, Query validation, Logs sanitis√©s, Timeout configurable
**Body** :
```json
{
  "query": "string",          // Requ√™te de recherche (max 500 chars, valid√©e)
  "limit": 10,              // Optionnel, nombre r√©sultats (max 20)
  "safe_search": true,      // Optionnel, recherche s√©curis√©e
  "user_id": "string"       // Optionnel
}
```
**R√©ponse** :
```json
{
  "results": [
    {
      "title": "string",
      "url": "string",
      "snippet": "string",
      "timestamp": "datetime"
    }
  ],
  "query": "string",
  "total_results": 10,
  "search_time": 1.2,
  "security_validated": true
}
```

### POST /web/content
**Description** : R√©cup√©ration s√©curis√©e du contenu d'une page web
**URL** : `http://localhost:8000/web/content`
**S√©curit√©** : URL validation, Timeout s√©curis√©, Content sanitization
**Body** :
```json
{
  "url": "string",           // URL valide (HTTPS recommand√©)
  "extract_text": true,     // Optionnel, extraction texte uniquement
  "timeout": 30,           // Optionnel, timeout en secondes
  "user_id": "string"      // Optionnel
}
```
**R√©ponse** :
```json
{
  "url": "string",
  "title": "string",
  "content": "string",          // Contenu sanitis√©
  "extracted_at": "datetime",
  "content_type": "text/html",
  "security_score": 9.5,
  "processing_time": 2.3
}
```

### POST /web/screenshot
**Description** : Capture d'√©cran s√©curis√©e de pages web
**URL** : `http://localhost:8000/web/screenshot`
**S√©curit√©** : URL validation stricte, Timeout limit√©, Resource monitoring
**Body** :
```json
{
  "url": "string",           // URL cible valid√©e
  "full_page": true,        // Optionnel, capture page compl√®te
  "width": 1920,           // Optionnel, largeur viewport
  "height": 1080,          // Optionnel, hauteur viewport  
  "format": "png",         // Optionnel, png|jpeg|webp
  "quality": 90            // Optionnel, qualit√© image
}
```
**R√©ponse** : Image binaire avec headers s√©curis√©s
**Headers** :
```
Content-Type: image/png
Content-Disposition: attachment; filename="screenshot_secure.png"
X-Screenshot-Time: 3.2
X-Security-Validated: true
```

---

## ‚öôÔ∏è **CONFIGURATION S√âCURIS√âE**

### Variables Environnement MCP
```bash
# S√©curit√© MCP
BROWSERBASE_API_KEY="your-secure-api-key"     # Masqu√© dans les logs
BROWSERBASE_PROJECT_ID="your-project-id"      # Valid√© au d√©marrage  
GEMINI_API_KEY="your-gemini-key"              # Optionnel, chiffr√©
MCP_TIMEOUT=30                                # Timeout global MCP
MCP_RATE_LIMIT=10                            # Requ√™tes/minute
MCP_SAFE_MODE=true                           # Mode s√©curis√© activ√©
```

---

## üîÑ **CODES D'ERREUR S√âCURIS√âS**

### 401 - Unauthorized
```json
{
  "detail": "Authentication required",
  "error_code": "AUTH_REQUIRED",
  "suggestion": "Provide valid JWT token in Authorization header"
}
```

### 429 - Rate Limit Exceeded
```json
{
  "detail": "Rate limit exceeded",
  "error_code": "RATE_LIMIT",
  "retry_after": 60,
  "current_limit": "10 requests per minute"
}
```

### 422 - Validation Error
```json
{
  "detail": "Input validation failed",
  "error_code": "VALIDATION_ERROR",
  "validation_errors": [
    {
      "field": "message",
      "error": "Message too long (max 10000 characters)"
    }
  ]
}
```

---

## üìä **M√âTRIQUES DE S√âCURIT√â**

### Indicateurs Disponibles
- **jarvis_auth_attempts_total** : Tentatives d'authentification
- **jarvis_rate_limit_hits_total** : D√©passements rate limit
- **jarvis_validation_errors_total** : Erreurs de validation input
- **jarvis_secure_sessions_active** : Sessions actives s√©curis√©es
- **jarvis_memory_cleanup_total** : Op√©rations cleanup m√©moire
- **jarvis_websocket_connections_secure** : Connexions WebSocket s√©curis√©es

---

## üîÑ **DERNI√àRE MISE √Ä JOUR**
**Date** : 2025-01-22 - 23:50  
**Par** : Instance Claude #47 (Security Update)  
**Version** : v1.3.1 - Production-Ready avec S√©curit√© Enterprise  
**Action** : Mise √† jour compl√®te API avec authentification JWT + endpoints s√©curis√©s  
**Score S√©curit√©** : 9.2/10 (vs 3.0/10 en v1.3.0)